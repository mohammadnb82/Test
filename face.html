<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ´Ø®ÛŒØµ Ú†Ù‡Ø±Ù‡</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/libs/face-api.min.js"></script>
    <style>
        #container { position: relative; margin: 0 auto; max-width: 100%; }
        #imageUpload { display: none; }
        canvas { position: absolute; top: 0; left: 0; }
        img { max-width: 100%; display: block; border-radius: 10px; }
        .loading { color: #f39c12; font-weight: bold; display: none; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡</a>
        <div class="card">
            <h2>ğŸ‘¤ Ø§Ø³Ú©Ù†Ø± Ú†Ù‡Ø±Ù‡ (TensorFlow JS)</h2>
            <div id="status" class="loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ù„ÙˆØ¯ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...</div>
            
            <div class="upload-box" onclick="document.getElementById('imageUpload').click()">
                ğŸ“· Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ Ú¯Ø±ÙØªÙ† Ø¹Ú©Ø³
            </div>
            <input type="file" id="imageUpload" accept="image/*">
            
            <div id="container">
                <img id="inputImage" src="" alt="" style="display:none;">
            </div>
        </div>
    </div>

    <script>
        const status = document.getElementById('status');
        const imageUpload = document.getElementById('imageUpload');
        const container = document.getElementById('container');
        const inputImage = document.getElementById('inputImage');
        let canvas;

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø§Ø² Ù¾ÙˆØ´Ù‡ assets/models Ø³Ø§ÛŒØª Ø®ÙˆØ¯ØªØ§Ù†
        async function loadModels() {
            status.style.display = 'block';
            status.innerHTML = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø§ÛŒØª...';
            try {
                // Ø¢Ø¯Ø±Ø³ Ù†Ø³Ø¨ÛŒ Ø¨Ù‡ Ù¾ÙˆØ´Ù‡ Ù…Ø¯Ù„â€ŒÙ‡Ø§
                const modelPath = './assets/models'; 
                await faceapi.nets.tinyFaceDetector.loadFromUri(modelPath);
                await faceapi.nets.faceLandmark68Net.loadFromUri(modelPath);
                status.innerHTML = 'âœ… Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª! Ø¹Ú©Ø³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.';
                status.style.color = 'green';
            } catch (err) {
                status.innerHTML = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§: ' + err;
                console.error(err);
            }
        }

        imageUpload.addEventListener('change', async () => {
            if (canvas) canvas.remove();
            const file = imageUpload.files[0];
            const imgUrl = URL.createObjectURL(file);
            inputImage.src = imgUrl;
            inputImage.style.display = 'block';

            // Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ±
            status.innerHTML = 'ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³Ú©Ù† Ú†Ù‡Ø±Ù‡...';
            status.style.display = 'block';

            // ØµØ¨Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØµÙˆÛŒØ± Ù„ÙˆØ¯ Ø´ÙˆØ¯
            inputImage.onload = async () => {
                const displaySize = { width: inputImage.width, height: inputImage.height };
                
                // Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÙˆÙ… Ù†Ù‚Ø§Ø´ÛŒ Ø±ÙˆÛŒ ØªØµÙˆÛŒØ±
                canvas = faceapi.createCanvasFromMedia(inputImage);
                container.append(canvas);
                faceapi.matchDimensions(canvas, displaySize);

                // ØªØ´Ø®ÛŒØµ Ú†Ù‡Ø±Ù‡â€ŒÙ‡Ø§
                const detections = await faceapi.detectAllFaces(inputImage, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);

                // Ø±Ø³Ù… Ú©Ø§Ø¯Ø± Ùˆ Ù†Ù‚Ø§Ø·
                faceapi.draw.drawDetections(canvas, resizedDetections);
                faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                
                status.innerHTML = `âœ… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯: ${detections.length} Ú†Ù‡Ø±Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯.`;
            };
        });

        loadModels();
    </script>
</body>
</html>