<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Smart Motion Camera</title>
    <style>
        body { 
            background-color: #000; 
            color: white; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0; 
            padding: 10px; 
            height: 100vh;
            overflow: hidden;
        }

        /* Video Area */
        .video-wrapper {
            width: 100%;
            max-width: 600px;
            position: relative;
            background: #111;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
            margin-bottom: 10px;
            /* Force Aspect Ratio */
            aspect-ratio: 4/3; 
        }

        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block;
        }

        /* Red overlay when alarm triggers */
        #alarmOverlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 0, 0, 0.3);
            display: none; 
            z-index: 10;
            box-shadow: inset 0 0 60px red;
            pointer-events: none;
        }

        /* Controls Area */
        .controls {
            width: 100%;
            max-width: 600px;
            background: #1c1c1e;
            padding: 15px;
            border-radius: 14px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 1. Motion Bar Graph */
        .graph-container {
            position: relative;
            width: 100%;
            height: 30px;
            background: #2c2c2e;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #3a3a3c;
        }

        .motion-bar {
            height: 100%;
            width: 0%;
            background: #32d74b; /* Green */
            transition: width 0.05s linear, background 0.2s;
        }

        /* The Red Threshold Line */
        .limit-line {
            position: absolute;
            top: 0; bottom: 0;
            width: 2px;
            background: #ff453a;
            z-index: 5;
            box-shadow: 0 0 5px rgba(255, 69, 58, 0.8);
            transform: translateX(-50%); /* Center the line on the value */
        }

        /* Scale Numbers under graph */
        .scale {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #8e8e93;
            padding: 0 5px;
            margin-top: -10px; /* pull closer to graph */
        }

        /* 2. Stats Display */
        .stats {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            font-weight: 700;
        }
        .stat-val { font-family: monospace; font-size: 18px; }
        .col-red { color: #ff453a; }
        .col-green { color: #32d74b; }

        /* 3. Slider */
        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider-label { font-size: 13px; color: #aeaeb2; white-space: nowrap; }
        
        input[type=range] {
            flex: 1;
            height: 20px;
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: #48484a;
            border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 22px;
            width: 22px;
            border-radius: 50%;
            background: #fff;
            margin-top: -8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* 4. Buttons */
        .btn-row {
            display: flex;
            gap: 10px;
        }
        button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn-rotate { background: #3a3a3c; }
        .btn-siren { background: #3a3a3c; color: #bbb; border: 1px solid #444; }
        
        /* Active Siren State */
        .btn-siren.on {
            background: #ff453a;
            color: white;
            border: none;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .back-link {
            margin-top: auto;
            margin-bottom: 20px;
            color: #636366;
            text-decoration: none;
            font-size: 14px;
        }

        /* Hidden Canvas for processing */
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="video-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <div id="alarmOverlay"></div>
    </div>
    <canvas id="canvas"></canvas>

    <div class="controls">
        
        <!-- Motion Visualizer -->
        <div>
            <div class="graph-container">
                <div id="motionBar" class="motion-bar"></div>
                <div id="limitLine" class="limit-line" style="left: 20%;"></div>
            </div>
            <div class="scale">
                <span>0</span><span>25</span><span>50</span><span>75</span><span>100</span>
            </div>
        </div>

        <!-- Numbers -->
        <div class="stats">
            <div class="col-red">Trigger: <span id="threshVal" class="stat-val">20</span>%</div>
            <div class="col-green">Motion: <span id="motionVal" class="stat-val">0</span>%</div>
        </div>

        <!-- Slider -->
        <div class="slider-row">
            <span class="slider-label">Alarm Threshold</span>
            <input type="range" id="slider" min="5" max="95" value="20">
        </div>

        <!-- Actions -->
        <div class="btn-row">
            <button class="btn-rotate" onclick="flipCamera()">
                üîÑ Flip Cam
            </button>
            <button id="sirenBtn" class="btn-siren" onclick="toggleSiren()">
                üîï Siren OFF
            </button>
        </div>

    </div>

    <a href="../index_tools.html" class="back-link">‚Üê Back to Tools</a>

    <script>
        // --- Elements ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        const motionBar = document.getElementById('motionBar');
        const limitLine = document.getElementById('limitLine');
        const motionValDisplay = document.getElementById('motionVal');
        const threshValDisplay = document.getElementById('threshVal');
        const slider = document.getElementById('slider');
        const alarmOverlay = document.getElementById('alarmOverlay');
        const sirenBtn = document.getElementById('sirenBtn');

        // --- State ---
        let stream = null;
        let facingMode = 'environment';
        let lastFrame = null;
        let isSirenOn = false;
        let alarmTriggered = false;

        // --- Audio Context (Siren) ---
        let audioCtx, osc, gain;
        
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playBeep() {
            if (!audioCtx) initAudio();
            // Create oscillator for each beep to ensure clean sound
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = 'square';
            o.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
            o.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
            
            g.gain.setValueAtTime(0.2, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

            o.connect(g);
            g.connect(audioCtx.destination);
            o.start();
            o.stop(audioCtx.currentTime + 0.15);
        }

        function toggleSiren() {
            initAudio();
            isSirenOn = !isSirenOn;
            if (isSirenOn) {
                sirenBtn.classList.add('on');
                sirenBtn.innerText = "üîî Siren ON";
                // Test beep
                playBeep();
            } else {
                sirenBtn.classList.remove('on');
                sirenBtn.innerText = "üîï Siren OFF";
                alarmOverlay.style.display = 'none';
            }
        }

        // --- Slider Logic ---
        slider.addEventListener('input', () => {
            const val = slider.value;
            limitLine.style.left = val + '%';
            threshValDisplay.innerText = val;
        });
        // Init visual
        limitLine.style.left = slider.value + '%';


        // --- Camera Logic ---
        async function startCam() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
            }
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: facingMode,
                        width: { ideal: 640 }, // request lower res for performance
                        height: { ideal: 480 }
                    },
                    audio: false
                });
                video.srcObject = stream;
                // Important: clear memory when cam starts
                lastFrame = null;
            } catch (err) {
                alert("Camera Access Denied or Error: " + err);
            }
        }

        function flipCamera() {
            facingMode = (facingMode === 'environment') ? 'user' : 'environment';
            lastFrame = null; // Prevent crash
            startCam();
        }

        // --- Processing Loop ---
        // We use a small canvas for processing (64x48) to be fast
        const PROC_W = 64;
        const PROC_H = 48;
        canvas.width = PROC_W;
        canvas.height = PROC_H;

        function loop() {
            if (video.readyState === 4) {
                try {
                    ctx.drawImage(video, 0, 0, PROC_W, PROC_H);
                    const frame = ctx.getImageData(0, 0, PROC_W, PROC_H);
                    const data = frame.data;
                    const len = data.length;

                    if (lastFrame) {
                        const prev = lastFrame.data;
                        let changedPixels = 0;
                        let totalBrightness = 0;

                        // 1. Calculate Pixels
                        for (let i = 0; i < len; i += 4) {
                            const r = data[i];
                            const g = data[i+1];
                            const b = data[i+2];

                            // Track brightness for night mode check
                            totalBrightness += (r + g + b);

                            const pr = prev[i];
                            const pg = prev[i+1];
                            const pb = prev[i+2];

                            // Absolute difference
                            const diff = Math.abs(r - pr) + Math.abs(g - pg) + Math.abs(b - pb);

                            // LOWER THRESHOLD: was 20, now 10 to see in dark
                            if (diff > 10) { 
                                changedPixels++;
                            }
                        }

                        // 2. Night Mode Booster
                        // Average brightness per pixel (0-765 max sum)
                        const avgBrightness = totalBrightness / (PROC_W * PROC_H);
                        // If very dark (avg < 100), boost the multiplier
                        let multiplier = 5; // Base sensitivity
                        if (avgBrightness < 150) {
                             multiplier = 10; // Double sensitivity in low light
                        }

                        // 3. Calculate Score (0-100)
                        const totalPix = PROC_W * PROC_H;
                        let percent = (changedPixels / totalPix) * 100;
                        
                        // Apply multiplier
                        let finalVal = Math.floor(percent * multiplier);
                        
                        // Clamp
                        if (finalVal > 100) finalVal = 100;
                        if (finalVal < 0) finalVal = 0;

                        // 4. Update UI
                        motionBar.style.width = finalVal + '%';
                        motionValDisplay.innerText = finalVal;

                        // 5. Check Alarm
                        const threshold = parseInt(slider.value);
                        
                        // Strict check: Is Motion > Threshold?
                        if (finalVal > threshold) {
                            motionBar.style.background = '#ff453a'; // Red bar
                            if (isSirenOn) {
                                alarmOverlay.style.display = 'block';
                                playBeep(); 
                            }
                        } else {
                            motionBar.style.background = '#32d74b'; // Green bar
                            alarmOverlay.style.display = 'none';
                        }
                    }

                    // Save frame
                    lastFrame = frame;

                } catch (e) {
                    console.error(e);
                    lastFrame = null;
                }
            }
            requestAnimationFrame(loop);
        }

        // Start
        startCam();
        // Start loop when video plays
        video.addEventListener('play', loop);

    </script>
</body>
</html>