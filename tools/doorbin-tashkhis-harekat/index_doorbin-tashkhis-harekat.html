<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    <style>
        body { 
            background-color: #121212; 
            color: white; 
            font-family: system-ui, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0; 
            padding: 10px; 
            height: 100vh;
            overflow: hidden;
        }

        /* Ù†Ø§Ø­ÛŒÙ‡ ÙˆÛŒØ¯ÛŒÙˆ */
        .video-container {
            width: 100%;
            max-width: 600px;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 10px;
            border: 1px solid #333;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { display: none; }
        
        /* Ù„Ø§ÛŒÙ‡ Ù‡Ø´Ø¯Ø§Ø± Ù‚Ø±Ù…Ø² Ø±ÙˆÛŒ Ú©Ù„ ØªØµÙˆÛŒØ± */
        #alarmLayer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 0, 0, 0.4);
            display: none; pointer-events: none; z-index: 5;
            box-shadow: inset 0 0 50px red;
        }

        /* Ù¾Ù†Ù„ Ú©Ù†ØªØ±Ù„ Ù…Ø´Ø§Ø¨Ù‡ Ø¹Ú©Ø³ Ø§Ø±Ø³Ø§Ù„ÛŒ */
        .control-panel {
            width: 100%;
            max-width: 600px;
            background: #1e1e1e;
            padding: 15px;
            border-radius: 12px;
            box-sizing: border-box;
        }

        /* Ø¨Ø®Ø´ Ú¯Ø±Ø§Ù Ø­Ø±Ú©Øª (Ø®Ø· Ú©Ø´ Ùˆ Ù†ÙˆØ§Ø±) */
        .motion-graph-wrapper {
            position: relative;
            margin-bottom: 5px;
        }
        
        .motion-track {
            height: 20px;
            background: #333;
            position: relative;
            border-radius: 3px;
            overflow: hidden;
        }
        
        /* Ù†ÙˆØ§Ø± Ø³Ø¨Ø² Ù…ÛŒØ²Ø§Ù† Ø­Ø±Ú©Øª */
        .motion-fill {
            height: 100%;
            width: 0%;
            background: #4caf50; /* Ø³Ø¨Ø² */
            transition: width 0.1s linear;
        }

        /* Ø®Ø· Ù‚Ø±Ù…Ø² Ø¢Ø³ØªØ§Ù†Ù‡ */
        .threshold-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff3b30; /* Ù‚Ø±Ù…Ø² */
            z-index: 10;
            transition: left 0.1s;
        }

        /* Ø§Ø¹Ø¯Ø§Ø¯ Ø²ÛŒØ± Ù†ÙˆØ§Ø± (0 ØªØ§ 100) */
        .scale-numbers {
            display: flex;
            justify-content: space-between;
            color: #888;
            font-size: 10px;
            margin-top: 2px;
            padding: 0 2px;
        }

        /* Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ø¯Ø§Ø¯ Ø¢Ø³ØªØ§Ù†Ù‡ Ùˆ Ø­Ø±Ú©Øª */
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
            font-weight: bold;
        }
        .stat-item { display: flex; align-items: center; gap: 5px; }
        .text-red { color: #ff3b30; }
        .text-green { color: #4caf50; }

        /* Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ø¢Ø¨ÛŒ */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .slider-label { font-size: 14px; color: #ccc; min-width: 60px; }
        input[type=range] {
            flex-grow: 1;
            height: 4px;
            border-radius: 2px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #007aff; /* Ø¢Ø¨ÛŒ */
            border-radius: 2px;
        }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .buttons-row {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }

        .btn-cam { background: #3a3a3c; } /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ ØªÛŒØ±Ù‡ */
        .btn-cam:active { background: #555; }

        .btn-siren { background: #3a3a3c; color: #aaa; border: 1px solid #444; }
        .btn-siren.active { 
            background: #ff3b30; 
            color: white; 
            border-color: #ff3b30;
            box-shadow: 0 0 15px rgba(255, 59, 48, 0.4);
        }

        .back-link {
            margin-top: 20px;
            color: #666;
            text-decoration: none;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <div class="video-container">
        <video id="video" autoplay playsinline muted></video>
        <div id="alarmLayer"></div>
    </div>
    <canvas id="canvas"></canvas>

    <div class="control-panel">
        
        <!-- Ú¯Ø±Ø§Ù Ø­Ø±Ú©Øª Ø¨Ø§ Ø®Ø· Ú©Ø´ Ùˆ Ø®Ø· Ø¢Ø³ØªØ§Ù†Ù‡ -->
        <div class="motion-graph-wrapper">
            <div class="motion-track">
                <div id="motionFill" class="motion-fill"></div>
                <div id="threshLine" class="threshold-line" style="left: 50%;"></div>
            </div>
            <div class="scale-numbers">
                <span>0</span><span>20</span><span>40</span><span>60</span><span>80</span><span>100</span>
            </div>
        </div>

        <!-- Ø§Ø¹Ø¯Ø§Ø¯ Ø¯Ù‚ÛŒÙ‚ -->
        <div class="stats-row">
            <span class="stat-item text-red">Ø¢Ø³ØªØ§Ù†Ù‡: <span id="threshText">50</span></span>
            <span class="stat-item text-green">Ø­Ø±Ú©Øª: <span id="motionText">0</span></span>
        </div>

        <!-- Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ø­Ø³Ø§Ø³ÛŒØª -->
        <div class="slider-container">
            <span class="slider-label">Ø­Ø³Ø§Ø³ÛŒØª:</span>
            <input type="range" id="sensitivitySlider" min="1" max="100" value="50">
        </div>

        <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
        <div class="buttons-row">
            <button class="btn btn-cam" onclick="switchCamera()">
                ğŸ”„ Ú†Ø±Ø®Ø´ Ø¯ÙˆØ±Ø¨ÛŒÙ†
            </button>
            <button id="sirenBtn" class="btn btn-siren" onclick="toggleSiren()">
                ğŸ”• Ø¢Ú˜ÛŒØ± Ø®Ø§Ù…ÙˆØ´
            </button>
        </div>
    </div>

    <a href="../index_tools.html" class="back-link">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§</a>

    <script>
        // Ø¹Ù†Ø§ØµØ± ØµÙØ­Ù‡
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const alarmLayer = document.getElementById('alarmLayer');
        
        const motionFill = document.getElementById('motionFill');
        const threshLine = document.getElementById('threshLine');
        const threshText = document.getElementById('threshText');
        const motionText = document.getElementById('motionText');
        const slider = document.getElementById('sensitivitySlider');
        const sirenBtn = document.getElementById('sirenBtn');

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ù†Ø·Ù‚ÛŒ
        let stream = null;
        let facingMode = 'environment';
        let lastFrameData = null;
        let isSirenActive = false;
        let audioCtx = null;
        let oscillator = null;
        let alarmTimeout;

        // --- 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØµØ¯Ø§ (Ø¢Ú˜ÛŒØ± Ø¯ÛŒØ¬ÛŒØªØ§Ù„) ---
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playBeep() {
            if (oscillator) return;
            initAudio();
            oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.type = 'sawtooth'; // ØµØ¯Ø§ÛŒ ØªÛŒØ²ØªØ±
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            oscillator.frequency.linearRampToValueAtTime(1200, audioCtx.currentTime + 0.1); // Ø§ÙÚ©Øª Ø¢Ú˜ÛŒØ±
            oscillator.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.2);

            gainNode.gain.value = 0.2; // Ø­Ø¬Ù… ØµØ¯Ø§
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
        }

        function stopBeep() {
            if (oscillator) {
                try { oscillator.stop(); oscillator.disconnect(); } catch(e){}
                oscillator = null;
            }
        }

        function toggleSiren() {
            isSirenActive = !isSirenActive;
            initAudio(); // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯Ù† ØµØ¯Ø§
            if (isSirenActive) {
                sirenBtn.classList.add('active');
                sirenBtn.innerHTML = "ğŸ”” Ø¢Ú˜ÛŒØ± ÙØ¹Ø§Ù„";
                playBeep(); setTimeout(stopBeep, 200); // ØµØ¯Ø§ÛŒ ØªØ³Øª Ú©ÙˆØªØ§Ù‡
            } else {
                sirenBtn.classList.remove('active');
                sirenBtn.innerHTML = "ğŸ”• Ø¢Ú˜ÛŒØ± Ø®Ø§Ù…ÙˆØ´";
                stopBeep();
            }
        }

        // --- 2. Ù…Ù†Ø·Ù‚ Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ùˆ Ø¢Ø³ØªØ§Ù†Ù‡ ---
        // Ø·Ø¨Ù‚ Ø¹Ú©Ø³: ÙˆÙ‚ØªÛŒ Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ø²ÛŒØ§Ø¯ Ù…ÛŒØ´ÙˆØ¯ØŒ Ø®Ø· Ù‚Ø±Ù…Ø² Ù‡Ù… Ø¬Ù„Ùˆ Ù…ÛŒØ±ÙˆØ¯.
        // ÛŒØ¹Ù†ÛŒ Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ø¢Ø³ØªØ§Ù†Ù‡ (Threshold) Ø±Ø§ ØªØ¹ÛŒÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
        slider.addEventListener('input', updateThreshold);

        function updateThreshold() {
            const val = parseInt(slider.value);
            threshText.innerText = val;
            threshLine.style.left = val + '%'; // Ø­Ø±Ú©Øª Ø®Ø· Ù‚Ø±Ù…Ø² Ø±ÙˆÛŒ Ù†ÙˆØ§Ø±
        }
        updateThreshold(); // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡

        // --- 3. Ø¯ÙˆØ±Ø¨ÛŒÙ† ---
        async function startCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: facingMode } 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯ÙˆØ±Ø¨ÛŒÙ†: " + err);
            }
        }

        function switchCamera() {
            facingMode = (facingMode === 'environment') ? 'user' : 'environment';
            startCamera();
        }

        // --- 4. Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ± Ùˆ ØªØ´Ø®ÛŒØµ Ø­Ø±Ú©Øª ---
        function processFrame() {
            if (video.readyState === 4) {
                const w = 50; // Ø±Ø²ÙˆÙ„ÙˆØ´Ù† Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø§
                const h = 50;
                canvas.width = w; canvas.height = h;
                
                ctx.drawImage(video, 0, 0, w, h);
                const currentData = ctx.getImageData(0, 0, w, h);
                const data = currentData.data;

                if (lastFrameData) {
                    const oldData = lastFrameData.data;
                    let diffScore = 0;

                    // Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù¾ÛŒÚ©Ø³Ù„â€ŒÙ‡Ø§
                    for (let i = 0; i < data.length; i += 4) {
                        const diff = Math.abs(data[i] - oldData[i]) +
                                     Math.abs(data[i+1] - oldData[i+1]) +
                                     Math.abs(data[i+2] - oldData[i+2]);
                        if (diff > 80) diffScore++;
                    }

                    // Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¹Ø¯Ø¯ Ø­Ø±Ú©Øª Ø¨ÛŒÙ† 0 ØªØ§ 100
                    // Ø¹Ø¯Ø¯ 400 ØªØ¬Ø±Ø¨ÛŒ Ø§Ø³Øª (Ø­Ø³Ø§Ø³ÛŒØª Ú©Ù„ÛŒ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ…)
                    let motionVal = Math.min(Math.floor((diffScore / 400) * 100), 100);
                    
                    // Ø¢Ù¾Ø¯ÛŒØª UI
                    motionText.innerText = motionVal;
                    motionFill.style.width = motionVal + '%';

                    // Ù…Ù†Ø·Ù‚ Ø¢Ú˜ÛŒØ±: Ø§Ú¯Ø± Ø­Ø±Ú©Øª (Ø³Ø¨Ø²) Ø§Ø² Ø¢Ø³ØªØ§Ù†Ù‡ (Ù‚Ø±Ù…Ø²) Ø±Ø¯ Ø´Ø¯
                    const thresholdVal = parseInt(slider.value);
                    
                    if (motionVal > thresholdVal) {
                        triggerAlarm();
                    } else {
                        stopAlarmVisuals();
                    }
                }
                lastFrameData = currentData;
            }
            requestAnimationFrame(processFrame);
        }

        function triggerAlarm() {
            alarmLayer.style.display = "block";
            motionFill.style.background = "#ff3b30"; // Ù†ÙˆØ§Ø± Ø³Ø¨Ø² Ù‚Ø±Ù…Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
            
            if (isSirenActive) {
                playBeep();
            }

            clearTimeout(alarmTimeout);
            alarmTimeout = setTimeout(stopAlarmVisuals, 200);
        }

        function stopAlarmVisuals() {
            alarmLayer.style.display = "none";
            motionFill.style.background = "#4caf50"; // Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø³Ø¨Ø²
            stopBeep();
        }

        // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
        startCamera();
        video.addEventListener('play', processFrame);

    </script>
</body>
</html>