<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªØ´Ø®ÛŒØµ Ø­Ø±Ú©Øª</title>
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: #000; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 10px; 
            box-sizing: border-box; 
        }
        
        .video-wrapper { 
            position: relative; 
            width: 100%; 
            max-width: 600px; 
            border: 2px solid #333; 
            border-radius: 12px; 
            overflow: hidden; 
            background: #111; 
            aspect-ratio: 4/3; 
        }
        
        video { width: 100%; height: 100%; object-fit: cover; display: block; }
        canvas { display: none; } 
        
        #alarmOverlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 0, 0, 0.3); border: 4px solid red;
            display: none; pointer-events: none; z-index: 10;
        }

        .controls { 
            width: 100%; 
            max-width: 600px; 
            background: #1a1a1a; 
            padding: 15px; 
            border-radius: 15px; 
            margin-top: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
        }
        
        .row { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 10px; }
        
        label { font-size: 14px; color: #ccc; white-space: nowrap; }
        
        input[type=range] { flex-grow: 1; height: 6px; border-radius: 5px; background: #444; outline: none; }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù†ÙˆØ§Ø± Ù…ÛŒØ²Ø§Ù† Ø­Ø±Ú©Øª */
        .motion-meter-container { 
            width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-top: 5px; 
        }
        .motion-meter-fill { 
            height: 100%; width: 0%; background: #0f0; transition: width 0.1s linear, background 0.2s; 
        }
        
        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn { 
            border: none; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; flex: 1; 
            display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; color: white;
        }
        
        .btn-camera { background: #333; border: 1px solid #444; }
        .btn-camera:active { background: #555; }

        .btn-siren { background: #222; border: 1px solid #444; color: #aaa; }
        .btn-siren.active { background: #dc3545; color: white; border-color: #dc3545; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .status-text { text-align: center; color: #888; font-size: 13px; margin-top: 5px; }
        .back-link { margin-top: 20px; color: #666; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>

    <div class="video-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <div id="alarmOverlay"></div>
    </div>
    <canvas id="canvas"></canvas>

    <div class="controls">
        <!-- Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„: Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ø­Ø³Ø§Ø³ÛŒØª -->
        <div class="row">
            <label>Ø­Ø³Ø§Ø³ÛŒØª (<span id="sensVal">20</span>):</label>
            <input type="range" id="sensitivity" min="5" max="100" value="20">
        </div>

        <!-- Ø±Ø¯ÛŒÙ Ø¯ÙˆÙ…: Ù†ÙˆØ§Ø± Ø³Ø¨Ø² Ø±Ù†Ú¯ (Ù…ÙˆØ´Ù† Ø¨Ø§Ø±) -->
        <div>
            <div class="row" style="margin-bottom: 2px;">
                <label style="font-size: 12px; color: #888;">Ù…ÛŒØ²Ø§Ù† Ø­Ø±Ú©Øª:</label>
            </div>
            <div class="motion-meter-container">
                <div id="motionBar" class="motion-meter-fill"></div>
            </div>
        </div>

        <!-- Ø±Ø¯ÛŒÙ Ø³ÙˆÙ…: Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ (Ø¯ÙˆØ±Ø¨ÛŒÙ† + Ø¢Ú˜ÛŒØ±) -->
        <div class="row">
            <!-- Ø¯Ú©Ù…Ù‡ ØªØºÛŒÛŒØ± Ø¯ÙˆØ±Ø¨ÛŒÙ† Ú©Ù‡ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ -->
            <button class="btn btn-camera" onclick="switchCamera()">
                ğŸ“· Ú†Ø±Ø®Ø´ Ø¯ÙˆØ±Ø¨ÛŒÙ†
            </button>
            
            <!-- Ø¯Ú©Ù…Ù‡ Ø¢Ú˜ÛŒØ± -->
            <button id="sirenBtn" class="btn btn-siren" onclick="toggleSiren()">
                ğŸ”• Ø¢Ú˜ÛŒØ± Ø®Ø§Ù…ÙˆØ´
            </button>
        </div>

        <div class="status-text" id="status">ÙˆØ¶Ø¹ÛŒØª: Ø¹Ø§Ø¯ÛŒ</div>
    </div>

    <a href="../index_tools.html" class="back-link">â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§</a>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const alarmOverlay = document.getElementById('alarmOverlay');
        const motionBar = document.getElementById('motionBar');
        const statusEl = document.getElementById('status');
        const sensInput = document.getElementById('sensitivity');
        const sensVal = document.getElementById('sensVal');
        const sirenBtn = document.getElementById('sirenBtn');

        let currentFacingMode = 'environment'; // Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        let stream = null;
        let lastFrameData = null;
        let isSirenEnabled = false;
        let alarmTimeout;

        // --- ØµØ¯Ø§ÛŒ Ø¢Ú˜ÛŒØ± Ø¯ÛŒØ¬ÛŒØªØ§Ù„ ---
        let audioCtx;
        let oscillator = null;
        
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playBeep() {
            if (oscillator) return; 
            initAudio();
            oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            oscillator.frequency.linearRampToValueAtTime(1500, audioCtx.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
        }

        function stopBeep() {
            if (oscillator) {
                try { oscillator.stop(); oscillator.disconnect(); } catch(e){}
                oscillator = null;
            }
        }
        // -------------------------

        async function startCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            try {
                // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¨Ø§ facingMode Ù…ØªØºÛŒØ±
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: currentFacingMode } 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera Error:", err);
                statusEl.innerText = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†";
            }
        }

        // ØªØ§Ø¨Ø¹ ØªØºÛŒÛŒØ± Ø¯ÙˆØ±Ø¨ÛŒÙ†
        function switchCamera() {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            startCamera();
        }

        function processFrame() {
            if (video.readyState === 4) {
                const w = 64; 
                const h = 48;
                canvas.width = w; canvas.height = h;
                
                ctx.drawImage(video, 0, 0, w, h);
                const currentData = ctx.getImageData(0, 0, w, h);

                if (lastFrameData) {
                    let movementScore = 0;
                    const data = currentData.data;
                    const oldData = lastFrameData.data;

                    for (let i = 0; i < data.length; i += 4) {
                        const diff = Math.abs(data[i] - oldData[i]) + 
                                     Math.abs(data[i+1] - oldData[i+1]) + 
                                     Math.abs(data[i+2] - oldData[i+2]);
                        if (diff > 50) movementScore++;
                    }

                    // Ø¢Ù¾Ø¯ÛŒØª Ù†ÙˆØ§Ø± Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ Ø­Ø±Ú©Øª
                    let barPercent = Math.min((movementScore / 300) * 100, 100);
                    motionBar.style.width = barPercent + "%";
                    if (barPercent > 40) motionBar.style.background = "#ff3333";
                    else motionBar.style.background = "#00ff00";

                    // Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø³ØªØ§Ù†Ù‡ Ù‡Ø´Ø¯Ø§Ø±
                    const sensitivity = parseInt(sensInput.value);
                    const threshold = (105 - sensitivity) * 5;

                    if (movementScore > threshold) {
                        triggerAlarm();
                    } else {
                        stopAlarmVisuals();
                    }
                }
                lastFrameData = currentData;
            }
            requestAnimationFrame(processFrame);
        }

        function triggerAlarm() {
            statusEl.innerText = "âš ï¸ Ø­Ø±Ú©Øª ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯!";
            statusEl.style.color = "#ff4444";
            alarmOverlay.style.display = "block";

            if (isSirenEnabled) {
                playBeep();
            }
            
            clearTimeout(alarmTimeout);
            alarmTimeout = setTimeout(stopAlarmVisuals, 200);
        }

        function stopAlarmVisuals() {
            statusEl.innerText = "ÙˆØ¶Ø¹ÛŒØª: Ø¹Ø§Ø¯ÛŒ";
            statusEl.style.color = "#888";
            alarmOverlay.style.display = "none";
            stopBeep();
        }

        // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
        sensInput.addEventListener('input', (e) => sensVal.innerText = e.target.value);
        
        function toggleSiren() {
            initAudio(); // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Context Ø¨Ø§ Ú©Ù„ÛŒÚ© Ú©Ø§Ø±Ø¨Ø±
            isSirenEnabled = !isSirenEnabled;
            if (isSirenEnabled) {
                sirenBtn.classList.add('active');
                sirenBtn.innerHTML = "ğŸ”” Ø¢Ú˜ÛŒØ± ÙØ¹Ø§Ù„";
            } else {
                sirenBtn.classList.remove('active');
                sirenBtn.innerHTML = "ğŸ”• Ø¢Ú˜ÛŒØ± Ø®Ø§Ù…ÙˆØ´";
                stopBeep();
            }
        }

        startCamera();
        video.addEventListener('play', processFrame);

    </script>
</body>
</html>