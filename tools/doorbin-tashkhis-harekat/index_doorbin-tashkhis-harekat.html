<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    <style>
        body { 
            background-color: #121212; 
            color: white; 
            font-family: system-ui, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0; 
            padding: 10px; 
            height: 100vh;
            overflow: hidden;
        }

        .video-container {
            width: 100%;
            max-width: 600px;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 10px;
            border: 1px solid #333;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { display: none; }
        
        #alarmLayer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 0, 0, 0.4);
            display: none; pointer-events: none; z-index: 5;
            box-shadow: inset 0 0 50px red;
        }

        .control-panel {
            width: 100%;
            max-width: 600px;
            background: #1e1e1e;
            padding: 15px;
            border-radius: 12px;
            box-sizing: border-box;
        }

        .motion-graph-wrapper {
            position: relative;
            margin-bottom: 5px;
        }
        
        .motion-track {
            height: 24px;
            background: #2c2c2e;
            position: relative;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #333;
            direction: rtl; /* 0 Ø³Ù…Øª Ø±Ø§Ø³Øª */
        }
        
        .motion-fill {
            height: 100%;
            width: 0%;
            background: #32d74b; /* Ø³Ø¨Ø² Ø±ÙˆØ´Ù† Ø§Ù¾Ù„ */
            transition: width 0.1s linear;
        }

        .threshold-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #ff453a; /* Ù‚Ø±Ù…Ø² Ø±ÙˆØ´Ù† */
            z-index: 10;
            box-shadow: 0 0 4px rgba(255, 69, 58, 0.8);
            transition: right 0.1s; /* Ø­Ø±Ú©Øª Ù†Ø±Ù… Ø§Ø² Ø±Ø§Ø³Øª */
        }

        .scale-numbers {
            display: flex;
            justify-content: space-between;
            color: #8e8e93;
            font-size: 11px;
            margin-top: 4px;
            padding: 0 2px;
            direction: ltr; /* Ú†ÛŒØ¯Ù…Ø§Ù† Ø§Ø¹Ø¯Ø§Ø¯ 100 Ú†Ù¾ - 0 Ø±Ø§Ø³Øª */
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 12px 0;
            font-size: 15px;
            font-weight: bold;
        }
        .stat-item { display: flex; align-items: center; gap: 6px; }
        .text-red { color: #ff453a; }
        .text-green { color: #32d74b; }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .slider-label { font-size: 14px; color: #aeaeb2; min-width: 60px; }
        
        input[type=range] {
            flex-grow: 1;
            height: 6px;
            border-radius: 3px;
            background: #3a3a3c;
            outline: none;
            -webkit-appearance: none;
            direction: ltr;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -9px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: #0a84ff;
            border-radius: 3px;
        }

        .buttons-row {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }

        .btn-cam { background: #3a3a3c; } 
        
        .btn-siren { background: #3a3a3c; color: #aaa; border: 1px solid #444; }
        .btn-siren.active { 
            background: #ff453a; 
            color: white; 
            border: none;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 69, 58, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 69, 58, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 69, 58, 0); }
        }

        .back-link {
            margin-top: 25px;
            color: #636366;
            text-decoration: none;
            font-size: 13px;
        }
    </style>
</head>
<body>

    <div class="video-container">
        <video id="video" autoplay playsinline muted></video>
        <div id="alarmLayer"></div>
    </div>
    <canvas id="canvas"></canvas>

    <div class="control-panel">
        
        <div class="motion-graph-wrapper">
            <div class="motion-track">
                <div id="motionFill" class="motion-fill"></div>
                <!-- Ø®Ø· Ù‚Ø±Ù…Ø² Ø¨Ø§ right ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§ Ø¨Ø§ Ø§Ø¹Ø¯Ø§Ø¯ 0 Ø±Ø§Ø³Øª Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø¨Ø§Ø´Ø¯ -->
                <div id="threshLine" class="threshold-line" style="right: 20%;"></div>
            </div>
            <div class="scale-numbers">
                <span>100</span><span>80</span><span>60</span><span>40</span><span>20</span><span>0</span>
            </div>
        </div>

        <div class="stats-row">
            <span class="stat-item text-red">Ø¢Ø³ØªØ§Ù†Ù‡: <span id="threshText">20</span></span>
            <span class="stat-item text-green">Ø­Ø±Ú©Øª: <span id="motionText">0</span></span>
        </div>

        <div class="slider-container">
            <span class="slider-label">Ø­Ø³Ø§Ø³ÛŒØª:</span>
            <!-- Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ú©Ù…ØªØ± Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø±Ø§Ø­Øªâ€ŒØªØ± -->
            <input type="range" id="sensitivitySlider" min="1" max="100" value="20">
        </div>

        <div class="buttons-row">
            <button class="btn btn-cam" onclick="switchCamera()">
                ğŸ”„ Ú†Ø±Ø®Ø´ Ø¯ÙˆØ±Ø¨ÛŒÙ†
            </button>
            <button id="sirenBtn" class="btn btn-siren" onclick="toggleSiren()">
                ğŸ”• Ø¢Ú˜ÛŒØ± Ø®Ø§Ù…ÙˆØ´
            </button>
        </div>
    </div>

    <a href="../index_tools.html" class="back-link">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§</a>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const alarmLayer = document.getElementById('alarmLayer');
        
        const motionFill = document.getElementById('motionFill');
        const threshLine = document.getElementById('threshLine');
        const threshText = document.getElementById('threshText');
        const motionText = document.getElementById('motionText');
        const slider = document.getElementById('sensitivitySlider');
        const sirenBtn = document.getElementById('sirenBtn');

        let stream = null;
        let facingMode = 'environment';
        let lastFrameData = null;
        let isSirenActive = false;
        
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ØµÙˆØªÛŒ Ø¬Ø¯ÛŒØ¯ (Ø¨Ø¯ÙˆÙ† Ø®Ø´)
        let audioCtx = null;
        let oscillator = null;
        let gainNode = null;
        let isBeeping = false;

        // --- 1. Ø³ÛŒØ³ØªÙ… ØµÙˆØªÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ (Ø¨Ø¯ÙˆÙ† Ù†ÙˆÛŒØ²) ---
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø§Ø³ÛŒÙ„Ø§ØªÙˆØ± Ø¯Ø§Ø¦Ù…ÛŒ
                oscillator = audioCtx.createOscillator();
                gainNode = audioCtx.createGain();
                
                oscillator.type = 'square'; // ØµØ¯Ø§ÛŒ Ù‡Ø´Ø¯Ø§Ø± Ù‚ÙˆÛŒ
                oscillator.frequency.value = 800; // ÙØ±Ú©Ø§Ù†Ø³ Ù¾Ø§ÛŒÙ‡
                
                // Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ ØµØ¯Ø§ Ù‚Ø·Ø¹ Ø§Ø³Øª (Gain = 0)
                gainNode.gain.value = 0;
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function startBeep() {
            if (gainNode && !isBeeping) {
                // Ø§ÙØ²Ø§ÛŒØ´ Ù†Ø±Ù… ØµØ¯Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² "ØªÙ‚"
                gainNode.gain.setTargetAtTime(0.3, audioCtx.currentTime, 0.05);
                
                // Ø§ÙÚ©Øª Ø¢Ú˜ÛŒØ± (ØªØºÛŒÛŒØ± ÙØ±Ú©Ø§Ù†Ø³)
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                
                isBeeping = true;
            }
        }

        function stopBeep() {
            if (gainNode && isBeeping) {
                // Ú©Ø§Ù‡Ø´ Ù†Ø±Ù… ØµØ¯Ø§
                gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
                isBeeping = false;
            }
        }

        function toggleSiren() {
            isSirenActive = !isSirenActive;
            initAudio(); // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø²Ù…ÛŒÙ†Ù‡ ØµÙˆØªÛŒ
            
            if (isSirenActive) {
                sirenBtn.classList.add('active');
                sirenBtn.innerHTML = "ğŸ”” Ø¢Ú˜ÛŒØ± ÙØ¹Ø§Ù„";
                // ØªØ³Øª Ú©ÙˆØªØ§Ù‡ ØµØ¯Ø§
                startBeep(); setTimeout(stopBeep, 150);
            } else {
                sirenBtn.classList.remove('active');
                sirenBtn.innerHTML = "ğŸ”• Ø¢Ú˜ÛŒØ± Ø®Ø§Ù…ÙˆØ´";
                stopBeep();
            }
        }

        // --- 2. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¢Ø³ØªØ§Ù†Ù‡ ---
        slider.addEventListener('input', updateThreshold);

        function updateThreshold() {
            const val = parseInt(slider.value);
            threshText.innerText = val;
            threshLine.style.right = val + '%'; // Ø­Ø±Ú©Øª Ø§Ø² Ø±Ø§Ø³Øª
        }
        updateThreshold();

        // --- 3. Ø¯ÙˆØ±Ø¨ÛŒÙ† ---
        async function startCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: facingMode } 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.");
            }
        }

        function switchCamera() {
            facingMode = (facingMode === 'environment') ? 'user' : 'environment';
            startCamera();
        }

        // --- 4. Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ± (Ø¨Ø§ Ø­Ø³Ø§Ø³ÛŒØª Ø¨Ø§Ù„Ø§) ---
        function processFrame() {
            if (video.readyState === 4) {
                const w = 64; // Ú©Ù…ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ú©ÛŒÙÛŒØª ØªØ­Ù„ÛŒÙ„
                const h = 48;
                canvas.width = w; canvas.height = h;
                
                ctx.drawImage(video, 0, 0, w, h);
                const currentData = ctx.getImageData(0, 0, w, h);
                const data = currentData.data;

                if (lastFrameData) {
                    const oldData = lastFrameData.data;
                    let diffScore = 0;

                    // Ø­Ù„Ù‚Ù‡ Ø±ÙˆÛŒ Ù¾ÛŒÚ©Ø³Ù„â€ŒÙ‡Ø§
                    for (let i = 0; i < data.length; i += 4) {
                        const rDiff = Math.abs(data[i] - oldData[i]);
                        const gDiff = Math.abs(data[i+1] - oldData[i+1]);
                        const bDiff = Math.abs(data[i+2] - oldData[i+2]);
                        
                        // Ø­Ø³Ø§Ø³ÛŒØª ØªØ´Ø®ÛŒØµ Ù¾ÛŒÚ©Ø³Ù„ Ø±Ø§ Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø¯ÛŒÙ… (Ø§Ø² 80 Ø¨Ù‡ 30 Ø±Ø³Ø§Ù†Ø¯ÛŒÙ…)
                        if ((rDiff + gDiff + bDiff) > 30) {
                            diffScore++;
                        }
                    }

                    // ÙØ±Ù…ÙˆÙ„ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø¨Ø³ÛŒØ§Ø± Ø­Ø³Ø§Ø³ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯
                    // ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù¾ÛŒÚ©Ø³Ù„â€ŒÙ‡Ø§ Ø­Ø¯ÙˆØ¯ 3000 Ø§Ø³Øª. 
                    // ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± 5 Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø¨Ø§ ØªØºÛŒÛŒØ±Ø§Øª Ú©Ù… Ù‡Ù… Ø¯Ø±ØµØ¯ Ø¨Ø§Ù„Ø§ Ø¨Ø±ÙˆØ¯.
                    let motionVal = Math.min(Math.floor(diffScore / 5), 100);
                    
                    // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù†ÙˆÛŒØ²Ù‡Ø§ÛŒ Ø®ÛŒÙ„ÛŒ Ø±ÛŒØ² (Ø²ÛŒØ± 2 Ø¯Ø±ØµØ¯ Ø±Ø§ ØµÙØ± Ú©Ù†)
                    if (motionVal < 2) motionVal = 0;

                    motionText.innerText = motionVal;
                    motionFill.style.width = motionVal + '%';

                    const thresholdVal = parseInt(slider.value);
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ú˜ÛŒØ±
                    if (motionVal > thresholdVal) {
                        alarmLayer.style.display = "block";
                        motionFill.style.background = "#ff453a"; // Ù†ÙˆØ§Ø± Ù‚Ø±Ù…Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
                        if (isSirenActive) startBeep();
                    } else {
                        alarmLayer.style.display = "none";
                        motionFill.style.background = "#32d74b"; // Ù†ÙˆØ§Ø± Ø³Ø¨Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
                        stopBeep();
                    }
                }
                lastFrameData = currentData;
            }
            requestAnimationFrame(processFrame);
        }

        startCamera();
        video.addEventListener('play', processFrame);

    </script>
</body>
</html>